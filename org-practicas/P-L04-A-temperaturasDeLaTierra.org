#    -*- mode: org -*-

#+Title: Lección 4.A --- Temperaturas de la tierra en desviaciones a la media del mes
#+author: Marcos Bujosa
#+LANGUAGE: es
#+OPTIONS: toc:nil
# +OPTIONS: author:nil
#+OPTIONS: date:nil

#+include: 00preambulo_practicas.txt

#+INFOJS_OPT: view:overview
# ###########
# ESTO DA EL FORMATO FINAL DE LA PÁGINA WEB VÉASE [[https://olmon.gitlab.io/org-themes/]]
#+SETUPFILE: ../css/bigblow_inline.theme
# ###########

#+name: setup-listings
#+begin_src emacs-lisp :exports none :results silent :tangle no
  (setq org-latex-listings 'listings)
  (setq org-latex-custom-lang-environments
  	;'((emacs-lisp "common-lispcode")))
  	'((emacs-lisp "hansl-gretl")))
  (setq org-latex-listings-options
	'(("frame" "lines")
	  ("basicstyle" "\\scriptsize")
	  ("basicstyle" "\\ttfamily")
	  ("numbers=none" "left")
	  ("backgroundcolor=\\color{lightgray!20}")
	  ("numberstyle" "\\tiny")))
  (setq org-latex-to-pdf-process
	'("pdflatex -interaction nonstopmode -output-directory %o %f"
	"pdflatex -interaction nonstopmode -output-directory %o %f"
	"pdflatex -interaction nonstopmode -output-directory %o %f"))
  (org-add-link-type
   "latex" nil
   (lambda (path desc format)
     (cond
      ((eq format 'html)
       (format "<span class=\"%s\">%s</span>" path desc))
      ((eq format 'latex)
       (format "\\%s{%s}" path desc)))))
#+end_src

#+NAME: if-no--guiones-makefir
#+BEGIN_SRC emacs-lisp :exports none :results silent :tangle no
(unless (file-directory-p "guiones")
  (make-directory "guiones"))
#+END_SRC

#+NAME: tangle-all-code-blocks
#+BEGIN_SRC emacs-lisp :exports none :results silent :tangle no
(org-babel-tangle)
#+END_SRC

#+begin_src emacs-lisp :results silent :exports none
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((latex . t)))
#+end_src


#+name: execute-gretl-practice
#+PROPERTY: P-L04-A-temperaturasDeLaTierra
#+BEGIN_SRC sh  :exports none  :results silent :var practica="P-L04-A-temperaturasDeLaTierra"
rm -fr $(pwd)/$practica
mkdir -p $(pwd)/$practica 
DIRECTORIO="$(pwd)/$practica" gretlcli -b $(pwd)/guiones/$practica.inp
# zip $practica $practica.* $practica/*
#+END_SRC

#+begin_src gretl :tangle guiones/P-L04-A-temperaturasDeLaTierra.inp :exports none :eval no
# ------------------------------------------------------------
# Copyright (C) 2025 Marcos Bujosa
# Licencia: GNU General Public License v3.0 o posterior
# Este código es software libre y puede ser redistribuido y/o modificado bajo los términos de la GPL.
# Ver el archivo LICENSE del repositorio para más detalles.
# ------------------------------------------------------------
#+end_src

#+begin_src gretl :tangle guiones/P-L04-A-temperaturasDeLaTierra.inp :exports none :eval no
# Los dos primeros comandos son necesarios para que Gretl guarde los resultados de la práctica en el directorio de trabajo
# al ejecutar lo siguiente desde un terminal (use los nombres y ruta que correspondan)
#
#    DIRECTORIO="Nombre_Directorio_trabajo" gretlcli -b ruta/nombre_fichero_de_la_practica.inp
#
# Si esto no le funciona en su sistema, comente las siguientes dos líneas y sitúese en el directorio de trabajo de gretl
# que corresponda (configure dicho directorio de trabajo desde la ventana principal de Gretl).

string directory = getenv("DIRECTORIO")
set workdir "@directory"
#+end_src
# string directory = $(pwd) ~ "/P-L04-A-temperaturasDeLaTierra" 


#+LATEX: \maketitle

#+LATEX: \blfootnote{Licencia: Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0).}

#+LATEX: \vspace{-1cm}


* Objetivo de la práctica

   | Guión: | [[https://mbujosab.github.io/Econometria-Aplicada/Practicas-html/guiones/P-L04-A-temperaturasDeLaTierra.inp][P-L04-A-temperaturasDeLaTierra.inp]] |


*Datos*

Temperaturas mensuales en desviaciones respecto a la media calculada entre los años 1951 y 1975. 
Datos obtenidos del libro de Daniel Peña [[https://www.alianzaeditorial.es/libro/manuales/analisis-de-series-temporales-daniel-pena-9788420669458/]["Análisis de Series Temporales"]].
Los puede descargar desde [[https://github.com/mbujosab/TimeSeriesData/blob/main/tempmundo.csv][aquí]]. 

*Objetivo*

1. Identificar un modelo para los datos.

Comencemos cargando los datos:

*/~Archivo --> Abrir datos --> Archivo de usuario~/* y en la ventana emergente busque el fichero =tempmundo.csv=
que previamente ha descargado desde aquí: https://github.com/mbujosab/TimeSeriesData/blob/main/tempmundo.csv

#+latex: {\vspace{0pt} \footnotesize \color{gray!70!black}
/o bien teclee en linea de comandos/:
#+NAME: Lectura del fichero de datos
#+begin_src gretl :eval no
open RutaAlDirectorioDelFichero/tempmundo.csv
setobs 12 1881:01
setinfo Temperature_Deviations --description="Temperaturas mensuales en desviaciones respecto a la media calculada entre los años 1951 y 1975"
#+end_src
donde =RutaAlDirectorioDelFichero= es la ruta al directorio donde guardó el fichero =tempmundo.csv=
#+latex: }

#+NAME: Lectura del fichero de datos
#+begin_src gretl :tangle ./guiones/P-L04-A-temperaturasDeLaTierra.inp :eval no :exports none
open ../../datos/tempmundo.csv
setobs 12 1881:01
setinfo Temperature_Deviations --description="Temperaturas mensuales en desviaciones respecto a la media calculada entre los años 1951 y 1975"
#+end_src
    
* Actividad 2 - Gráfico de series temporales
***** Scatter plot
- Marque la variable =Temperature_Deviations= (pulsando ~ctrl~ y pinchando con el botón derecho del ratón sobre ella). Elija */~Gráfico de series temporales~/*

  #+latex: {\vspace{1pt} \footnotesize \color{gray!70!black}
  /o bien teclee en linea de comandos/: =gnuplot Temperature_Deviations --time-series --with-lines=
  #+latex: }

***** Guardar gráfico como /icono/ para editarlo más tarde
- ``Pinche'' con el botón derecho sobre la ventana del gráfico.
- Seleccione */~Guardar a sesión como icono~/*

  #+latex: {\vspace{1pt} \footnotesize \color{gray!70!black} \color{gray!70!black}
  /o bien teclee en linea de comandos/:
    #+NAME: Guardamos scatterplot como icono
    #+begin_src gretl :tangle ./guiones/P-L04-A-temperaturasDeLaTierra.inp :eval no 
DesvTemp <- gnuplot Temperature_Deviations --time-series --with-lines  --output="Temperaturas.png"
    #+end_src

    (=DesvTemp= /es el nombre con el que se guardará el icono/. El comando  ~--output=~  seguido de un nombre entre comillas es para que Gretl genere un fichero =.png= con el nombre indicado y que contenga la figura. Yo lo he añadido para poder insertar el gráfico en este documento; pero no es necesario para generar el gráfico ni el icono).
  #+latex: }

#+ATTR_LATEX: :width 0.45\textwidth :center
[[./P-L04-A-temperaturasDeLaTierra/Temperaturas.png]]

Dada la muestra,
- ¿podemos considerar que la serie temporal tiene el aspecto de realización de un proceso estocástico estacionario?
- ¿Crece la variabilidad de los datos con su nivel medio? ¿Es viable la transformación logarítmica de los datos?


* Actividad 3 - Primera diferencia de los datos

Seleccione con el ratón la variable =Temperature_Deviations= y luego pulse en el menú desplegable */~Añadir~/* que aparece arriba, en el centro de la ventana principal de [[https://gretl.sourceforge.net/es.html][Gretl]].
  + */~Añadir -> Primeras diferencias de las variables seleccionadas~/*

    #+latex: {\vspace{0pt} \footnotesize \color{gray!70!black}
    /o bien teclee en linea de comandos/: 
      #+begin_src gretl :tangle ./guiones/P-L04-A-temperaturasDeLaTierra.inp :eval no 
diff Temperature_Deviations
      #+end_src
    #+latex: }

Entre las variables aparecerá una nueva con el prefijo =d_=, es decir, en este caso aparecerá la variable =d_Temperature_Deviations=.

Genere el gráfico de series temporales de esta nueva serie y guárdelo como un nuevo icono (Use un nombre suficientemente descriptivo, por ejemplo =Dif_DesvTemp=)

#+latex: {\vspace{0pt} \footnotesize \color{gray!70!black}
#+begin_src gretl :tangle ./guiones/P-L04-A-temperaturasDeLaTierra.inp :eval no :results none
Dif_DesvTemp <- gnuplot d_Temperature_Deviations --time-series --with-lines --output="Dif_Temperaturas.png"
#+end_src
#+latex: }

#+ATTR_LATEX: :width 0.45\textwidth :center
[[./P-L04-A-temperaturasDeLaTierra/Dif_Temperaturas.png]]

- ¿podemos considerar que la serie temporal en primeras diferencias tiene el aspecto de realización de un proceso estocástico estacionario?


* Actividad 3 - Estimar la función de autocorrelación (ACF) y la  función de autocorrelación parcial (PACF)

Seleccione con el ratón la variable =d_Temperature_Deviations= y luego pulse sobre la serie con el botón derecho de ratón. En el menú desplegable pulse en  */~Correlograma~/*; y en el la ventana emergente pulse en */~Aceptar~/*.

    #+latex: {\vspace{0pt} \footnotesize \color{gray!70!black}
    /o bien teclee en linea de comandos/: 
      #+begin_src gretl :tangle ./guiones/P-L04-A-temperaturasDeLaTierra.inp :eval no 
corrgm d_Temperature_Deviations 31 --plot="Dif_Temperature_Deviations-ACF-PACF.png"
      #+end_src
La instrucción ~--plot="Dif_Temperature_Deviations-ACF-PACF.png"~ no es necesaria si no necesita crear un fichero =.png= con el correlograma (yo lo necesito para mostrar el gráfico a continuación). 
    #+latex: }

#+ATTR_LATEX: :width 0.45\textwidth :center
[[./P-L04-A-temperaturasDeLaTierra/Dif_Temperature_Deviations-ACF-PACF.png]]

Podemos observar que la ACF cae abruptamente tras el primer retardo y que la PACF decae exponencialmente.

** Estimación de la densidad espectral

También podemos calcular el periodograma, que es un estimador de la densidad espectral.

Seleccione con el ratón la variable =d_Temperature_Deviations= y luego pulse sobre la serie con el botón derecho de ratón. En el menú desplegable pulse en */~Periodograma~/*; y en el la ventana emergente pulse en */~Aceptar~/*.

    #+latex: {\vspace{0pt} \footnotesize \color{gray!70!black}
    /o bien teclee en linea de comandos/: 
      #+begin_src gretl :tangle ./guiones/P-L04-A-temperaturasDeLaTierra.inp :eval no 
pergm d_Temperature_Deviations --plot="Dif_Temperature_Deviations-Periodograma.png"
      #+end_src
La instrucción ~--plot="Dif_Temperature_Deviations-ACF-PACF.png"~ no es necesaria si no necesita crear un fichero =.png= con el periodograma (yo lo necesito para mostrar el gráfico a continuación). 
    #+latex: }


#+ATTR_LATEX: :width 0.45\textwidth :center
[[./P-L04-A-temperaturasDeLaTierra/Dif_Temperature_Deviations-Periodograma.png]]

Al comparar el correlograma y el periodograma con las ACF, PACF y espectros vistos en clase, podemos deducir que la primera diferencia de los datos parece la realización de MA(1) con parámetro positivo:
$$X_t=(1-\theta \mathsf{B})U_t\qquad {\color{blue}{(\theta>0)}}$$

#+attr_html: :width 600px
#+ATTR_LATEX: :width 0.8\textwidth :center
[[file:./img/ACF-MA1p.png]]

* Código completo de la práctica

#+latex: {\vspace{10pt}
#+latex: \noindent
[[https://mbujosab.github.io/Econometria-Aplicada/Practicas-html/guiones/P-L04-A-temperaturasDeLaTierra.inp][P-L04-A-temperaturasDeLaTierra.inp]]
#+latex: \vspace{10pt}
#+LATEX: \lstinputlisting{guiones/P-L04-A-temperaturasDeLaTierra.inp}
#+LATEX: \clearpage }

