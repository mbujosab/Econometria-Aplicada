#    -*- mode: org -*-

#+Title: Lección 8.B --- Temperaturas de la tierra en desviaciones a la media del mes
#+author: Marcos Bujosa
#+LANGUAGE: es
#+OPTIONS: toc:nil
# +OPTIONS: author:nil
#+OPTIONS: date:nil

#+include: 00preambulo_practicas.txt

#+INFOJS_OPT: view:overview
# ###########
# ESTO DA EL FORMATO FINAL DE LA PÁGINA WEB VÉASE [[https://olmon.gitlab.io/org-themes/]]
#+SETUPFILE: ../css/bigblow_inline.theme
# ###########

#+name: setup-listings
#+begin_src emacs-lisp :exports none :results silent :tangle no
  (setq org-latex-listings 'listings)
  (setq org-latex-custom-lang-environments
  	;'((emacs-lisp "common-lispcode")))
  	'((emacs-lisp "hansl-gretl")))
  (setq org-latex-listings-options
	'(("frame" "lines")
	  ("basicstyle" "\\scriptsize")
	  ("basicstyle" "\\ttfamily")
	  ("numbers=none" "left")
	  ("backgroundcolor=\\color{lightgray!20}")
	  ("numberstyle" "\\tiny")))
  (setq org-latex-to-pdf-process
	'("pdflatex -interaction nonstopmode -output-directory %o %f"
	"pdflatex -interaction nonstopmode -output-directory %o %f"
	"pdflatex -interaction nonstopmode -output-directory %o %f"))
  (org-add-link-type
   "latex" nil
   (lambda (path desc format)
     (cond
      ((eq format 'html)
       (format "<span class=\"%s\">%s</span>" path desc))
      ((eq format 'latex)
       (format "\\%s{%s}" path desc)))))
#+end_src

#+NAME: if-no--guiones-makefir
#+BEGIN_SRC emacs-lisp :exports none :results silent :tangle no
(unless (file-directory-p "guiones")
  (make-directory "guiones"))
#+END_SRC

#+NAME: tangle-all-code-blocks
#+BEGIN_SRC emacs-lisp :exports none :results silent :tangle no
(org-babel-tangle)
#+END_SRC

#+begin_src emacs-lisp :results silent :exports none
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((latex . t)))
#+end_src


#+name: execute-gretl-practice
#+PROPERTY: P-L08-B-temperaturasDeLaTierra
#+BEGIN_SRC sh  :exports none  :results silent :var practica="P-L08-B-temperaturasDeLaTierra"
rm -fr $(pwd)/$practica
mkdir -p $(pwd)/$practica 
DIRECTORIO="$(pwd)/$practica" gretlcli -b $(pwd)/guiones/$practica.inp
# zip $practica $practica.* $practica/*
#+END_SRC

#+BEGIN_SRC gretl :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :exports none :eval no

#+END_SRC

#+begin_src gretl :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :exports none :eval no
# Los dos primeros comandos son necesarios para que Gretl guarde los resultados de la práctica en el directorio de trabajo
# al ejecutar lo siguiente desde un terminal (use los nombres y ruta que correspondan)
#
#    DIRECTORIO="Nombre_Directorio_trabajo" gretlcli -b ruta/nombre_fichero_de_la_practica.inp
#
# Si esto no le funciona en su sistema, comente las siguientes dos líneas y sitúese en el directorio de trabajo de gretl
# que corresponda (configure dicho directorio de trabajo desde la ventana principal de Gretl).

string directory = getenv("DIRECTORIO")
set workdir "@directory"
#+end_src
# string directory = $(pwd) ~ "/P-L08-B-temperaturasDeLaTierra" 


#+LATEX: \maketitle

#+LATEX: \blfootnote{Licencia: Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0).}

#+LATEX: \vspace{-1cm}

* Objetivo de la práctica

   | Guión: | [[https://mbujosab.github.io/Econometria-Aplicada/Practicas-html/guiones/P-L08-B-temperaturasDeLaTierra.inp][P-L08-B-temperaturasDeLaTierra.inp]] |


*Datos*

Temperaturas mensuales en desviaciones respecto a la media calculada entre los años 1951 y 1975. 
Datos obtenidos del libro de Daniel Peña [[https://www.alianzaeditorial.es/libro/manuales/analisis-de-series-temporales-daniel-pena-9788420669458/]["Análisis de Series Temporales"]].
Los puede descargar desde [[https://github.com/mbujosab/TimeSeriesData/blob/main/tempmundo.csv][aquí]]. 

*Objetivo*

1. Hacer previsión de los últimos años de la muestra mediante un modelo ARIMA.

Comencemos cargando los datos:

*/~Archivo --> Abrir datos --> Archivo de usuario~/* y en la ventana emergente busque el fichero =tempmundo.csv=
que previamente ha descargado desde aquí: https://github.com/mbujosab/TimeSeriesData/blob/main/tempmundo.csv

#+latex: {\vspace{0pt} \footnotesize \color{gray!70!black}
/o bien teclee en linea de comandos/:
#+NAME: Lectura del fichero de datos
#+begin_src gretl :eval no
open RutaAlDirectorioDelFichero/tempmundo.csv
setobs 12 1881:01
setinfo Temperature_Deviations --description="Temperaturas mensuales en desviaciones respecto a la media calculada entre los años 1951 y 1975"
#+end_src
donde =RutaAlDirectorioDelFichero= es la ruta al directorio donde guardó el fichero =tempmundo.csv=
#+latex: }

#+NAME: Lectura del fichero de datos
#+begin_src gretl :tangle ./guiones/P-L08-B-temperaturasDeLaTierra.inp :eval no :exports none
open ../../datos/tempmundo.csv
setobs 12 1881:01
setinfo Temperature_Deviations --description="Temperaturas mensuales en desviaciones respecto a la media calculada entre los años 1951 y 1975"
#+end_src
    

* Actividad 1 - Gráfico de series temporales

- Marque la variable =Temperature_Deviations= (pulsando ~ctrl~ y pinchando con el botón derecho del ratón sobre ella). Elija */~Gráfico de series temporales~/*

#+latex: {\vspace{1pt} \footnotesize \color{gray!70!black}
/o bien teclee en linea de comandos/:
#+NAME: Guardamos scatterplot como icono
#+begin_src gretl :tangle ./guiones/P-L08-B-temperaturasDeLaTierra.inp :eval no 
DesvTemp <- gnuplot Temperature_Deviations --time-series --with-lines  --output="Temperaturas.png"
#+end_src
#+latex: }

#+BEGIN_CENTER
#+attr_org: :width 500
#+attr_hmlt: :width 500
#+ATTR_LATEX: :width 0.45\textwidth :center t
[[./P-L08-B-temperaturasDeLaTierra/Temperaturas.png]]
#+END_CENTER


* Actividad 2 - Correlograma de la primera diferencia de los datos

Seleccione con el ratón la variable =Temperature_Deviations= y luego pulse en el menú desplegable */~Añadir~/* que aparece arriba, en el centro de la ventana principal de [[https://gretl.sourceforge.net/es.html][Gretl]].
  + */~Añadir -> Primeras diferencias de las variables seleccionadas~/*

#+latex: {\vspace{0pt} \footnotesize \color{gray!70!black}
/o bien teclee en linea de comandos/: 
#+begin_src gretl :tangle ./guiones/P-L08-B-temperaturasDeLaTierra.inp :eval no 
diff Temperature_Deviations
#+end_src
#+latex: }

Entre las variables aparecerá una nueva con el prefijo =d_=, es decir, en este caso aparecerá la variable =d_Temperature_Deviations=.

Genere el gráfico de series temporales de esta nueva serie y guárdelo como un nuevo icono (Use un nombre suficientemente descriptivo, por ejemplo =Dif_DesvTemp=)

#+latex: {\vspace{0pt} \footnotesize \color{gray!70!black}
#+begin_src gretl :tangle ./guiones/P-L08-B-temperaturasDeLaTierra.inp :eval no :results none
Dif_DesvTemp <- gnuplot d_Temperature_Deviations --time-series --with-lines --output="Dif_Temperaturas.png"
#+end_src
#+latex: }

#+BEGIN_CENTER
#+attr_org: :width 500
#+attr_hmlt: :width 500
#+ATTR_LATEX: :width 0.45\textwidth :center t
[[./P-L08-B-temperaturasDeLaTierra/Dif_Temperaturas.png]]
#+END_CENTER


Seleccione con el ratón la variable =d_Temperature_Deviations= y luego pulse sobre la serie con el botón derecho de ratón. En el menú desplegable pulse en  */~Correlograma~/*; y en el la ventana emergente pulse en */~Aceptar~/*.

#+latex: {\vspace{0pt} \footnotesize \color{gray!70!black}
/o bien teclee en linea de comandos/: 
#+begin_src gretl :tangle ./guiones/P-L08-B-temperaturasDeLaTierra.inp :eval no 
corrgm d_Temperature_Deviations 31 --plot="Dif_Temperature_Deviations-ACF-PACF.png"
#+end_src
La instrucción ~--plot="Dif_Temperature_Deviations-ACF-PACF.png"~ no es necesaria si no necesita crear un fichero =.png= con el correlograma (yo lo necesito para mostrar el gráfico a continuación). 
#+latex: }

#+BEGIN_CENTER
#+attr_org: :width 500
#+attr_hmlt: :width 500
#+ATTR_LATEX: :width 0.45\textwidth :center t
[[./P-L08-B-temperaturasDeLaTierra/Dif_Temperature_Deviations-ACF-PACF.png]]
#+END_CENTER

#+begin_src R :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :results none :exports none :noweb yes
outfile --quiet d_Temperature-ACF-PACF.txt
  corrgm d_Temperature_Deviations 12 --quiet
end outfile
#+end_src

#+latex: {\vspace{1pt} \footnotesize \color{gray!70!black}
#+include: ./P-L08-B-temperaturasDeLaTierra/d_Temperature-ACF-PACF.txt example
#+latex: }


* Actividad 3 - Identificar un modelo ARIMA para la serie temporal

A primera vista parece que la ACF cae abruptamente tras el primer retardo y que la PACF decae exponencialmente. Esto sugiere un modelo MA(1). Estime un modelo IMA(1) para los datos y analice los resultados.[fn::Ésta es la primera impresión a la vista del gráfico, pero si observa los estadísticos individuales verá que los tres primeros retardos son significativos, por lo que cualquier estudiante avezado podrá anticipar que este intento resultará fallido.]


** Intentado con un ARIMA(0,1,1)

#+NAME: Modelo ARIMA 0 1 1 con cte
#+begin_src R :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :results none :exports code 
ARIMA011 <- arima 0 1 1 ; Temperature_Deviations
#+end_src

#+begin_src R :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :results none :exports none :noweb yes
outfile --quiet ARIMA011.txt
  <<Modelo ARIMA 0 1 1 con cte>>
end outfile
#+end_src

#+include: ./P-L08-B-temperaturasDeLaTierra/ARIMA011.txt example

La constante no es significativa, pero el parámetro $\theta_1$ sí lo es y la raíz MA está alejada de uno. Veamos el correlograma.

*** Correlograma de los residuos

#+NAME: Modelo ARIMA 0 1 1 con cte
#+begin_src R :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :results none :exports code 
residuosARIMA011 = $uhat
corrgm residuosARIMA011 --plot="residuosARIMA011-ACF-PACF.png"
#+end_src

#+begin_src R :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :results none :exports none :noweb yes
outfile --quiet CorrelogramaARIMA011.txt
  corrgm residuosARIMA011 12 --quiet
end outfile
#+end_src

#+BEGIN_CENTER
#+attr_org: :width 500
#+attr_hmlt: :width 500
#+ATTR_LATEX: :width 0.45\textwidth :center t
[[./P-L08-B-temperaturasDeLaTierra/residuosARIMA011-ACF-PACF.png]]
#+END_CENTER


#+latex: {\vspace{1pt} \footnotesize \color{gray!70!black}
#+include: ./P-L08-B-temperaturasDeLaTierra/CorrelogramaARIMA011.txt example
#+latex: }

Concluimos que el modelo no es una IMA(1): los residuos distan mucho de parecer ruído blanco (muchos retardos individualmente significativos y p-valores para los estadísticos Q de Ljung-Box casi nulos).

Si volvemos sobre el correlograma inicial, es posible que la ACF no se haya truncado tras el primer retardo. Los retardos 2 y 3 son estadísticamente significativos individualmente. Quizá el modelo es un ARIMA(0,1,3). 

Pruebe con esta nueva especificación ARIMA(0,1,3) sin constante (si la incluye constará que no es significativa).

** Intentado con un ARIMA(0,1,3)

#+NAME: Modelo ARIMA 0 1 3 sin cte
#+begin_src R :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :results none :exports code 
ARIMA013 <- arima 0 1 3 ; Temperature_Deviations --nc
#+end_src

#+begin_src R :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :results none :exports none :noweb yes
outfile --quiet ARIMA013.txt
  <<Modelo ARIMA 0 1 3 sin cte>>
end outfile
#+end_src

#+include: ./P-L08-B-temperaturasDeLaTierra/ARIMA013.txt example

Todos los parámetros son significativos, y las raíces del polinomio MA están claramente fuera del círculo unidad. 
El R-cuadrado indica que este modelo es capaz de replicar casi el 75% de la varianza muestral de los datos. 
Analicemos ahora el correlograma.

*** Correlograma de los residuos

#+begin_src R :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :results none :exports code 
residuosARIMA013 = $uhat
corrgm residuosARIMA013 12 --plot="residuosARIMA013-ACF-PACF.png"
#+end_src

#+begin_src R :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :results none :exports none :noweb yes
outfile --quiet CorrelogramaARIMA013.txt
  corrgm residuosARIMA013 12 --quiet
end outfile
#+end_src

#+BEGIN_CENTER
#+attr_org: :width 500
#+attr_hmlt: :width 500
#+ATTR_LATEX: :width 0.45\textwidth :center t
[[./P-L08-B-temperaturasDeLaTierra/residuosARIMA013-ACF-PACF.png]]
#+END_CENTER


#+latex: {\vspace{1pt} \footnotesize \color{gray!70!black}
#+include: ./P-L08-B-temperaturasDeLaTierra/CorrelogramaARIMA013.txt example
#+latex: }

Los primeros retardos son conjuntamente nulos (hasta el retardo 8 los estadísticos Q de Ljung-Box tienen p-valores superiores a =0.9=); por lo que el modelo es satisfactorio.[fn::Pruebe con otras especificaciones, verá que no es fácil mejorar el modelo.]


* Actividad 4 - Previsión para los 12 meses de 2002

Queremos hacer previsión con este último modelo; y poder comparar sus previsiones con las observaciones correspondientes al año 2002. 

Para hacer este ejercicio, debemos estimar el modelo sin incorporar los datos de dicho año (prever algo que ya ha sido observado no tiene mérito). Dicho de otro modo, debemos usar el conjunto de información $\mathcal{H}_{Y_{2001:12}}$ de tal manera que las temperaturas de loss meses de 2002 no sean ``observadas''.

** Re-estimación del modelo truncando la muestra

#+begin_src R :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :results none :exports code 
smpl 1881:01 2001:12
ARIMA013_2001 <- arima 0 1 3 ; Temperature_Deviations --nc
#+end_src

** Previsión de los 12 últimos meses de la muestra

#+begin_src R :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :results none :exports code 
fcast 2000:01 2002:12 --plot="prediccion2002.png"
#+end_src


#+BEGIN_CENTER
#+attr_org: :width 500
#+attr_hmlt: :width 500
#+ATTR_LATEX: :width 0.45\textwidth :center t
[[./P-L08-B-temperaturasDeLaTierra/prediccion2002.png]]
#+END_CENTER

Fíjese que todas las temperaturas están dentro delos intervalos de confianza salvo marzo de 2002, que experimentó una temperatura extraordinariamente elevada.

#+begin_src R :tangle guiones/P-L08-B-temperaturasDeLaTierra.inp :results none :exports none :noweb yes
outfile --quiet Predicciones.txt
  fcast --out-of-sample
end outfile
#+end_src

#+latex: {\vspace{1pt} \footnotesize \color{gray!70!black}
#+include: ./P-L08-B-temperaturasDeLaTierra/Predicciones.txt example
#+latex: }

* Código completo de la práctica

#+latex: {\vspace{10pt}
#+latex: \noindent
[[https://mbujosab.github.io/Econometria-Aplicada/Practicas-html/guiones/P-L08-B-temperaturasDeLaTierra.inp][P-L08-B-temperaturasDeLaTierra.inp]]
#+latex: \vspace{10pt}
#+LATEX: \lstinputlisting{guiones/P-L08-B-temperaturasDeLaTierra.inp}
#+LATEX: \clearpage }
