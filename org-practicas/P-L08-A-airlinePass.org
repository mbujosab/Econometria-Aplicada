#    -*- mode: org -*-

#+Title: Lección 8.A --- Número de viajeros internacionales
#+author: Marcos Bujosa
#+LANGUAGE: es
#+OPTIONS: toc:nil
# +OPTIONS: author:nil
#+OPTIONS: date:nil

#+include: 00preambulo_practicas.txt

#+INFOJS_OPT: view:overview
# ###########
# ESTO DA EL FORMATO FINAL DE LA PÁGINA WEB VÉASE [[https://olmon.gitlab.io/org-themes/]]
#+SETUPFILE: ../css/bigblow_inline.theme
# ###########

#+name: setup-listings
#+begin_src emacs-lisp :exports none :results silent :tangle no
  (setq org-latex-listings 'listings)
  (setq org-latex-custom-lang-environments
  	;'((emacs-lisp "common-lispcode")))
  	'((emacs-lisp "hansl-gretl")))
  (setq org-latex-listings-options
	'(("frame" "lines")
	  ("basicstyle" "\\scriptsize")
	  ("basicstyle" "\\ttfamily")
	  ("numbers=none" "left")
	  ("backgroundcolor=\\color{lightgray!20}")
	  ("numberstyle" "\\tiny")))
  (setq org-latex-to-pdf-process
	'("pdflatex -interaction nonstopmode -output-directory %o %f"
	"pdflatex -interaction nonstopmode -output-directory %o %f"
	"pdflatex -interaction nonstopmode -output-directory %o %f"))
  (org-add-link-type
   "latex" nil
   (lambda (path desc format)
     (cond
      ((eq format 'html)
       (format "<span class=\"%s\">%s</span>" path desc))
      ((eq format 'latex)
       (format "\\%s{%s}" path desc)))))
#+end_src

#+NAME: if-no--guiones-makefir
#+BEGIN_SRC emacs-lisp :exports none :results silent :tangle no
(unless (file-directory-p "guiones")
  (make-directory "guiones"))
#+END_SRC

#+NAME: tangle-all-code-blocks
#+BEGIN_SRC emacs-lisp :exports none :results silent :tangle no
(org-babel-tangle)
#+END_SRC

#+begin_src emacs-lisp :results silent :exports none
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((latex . t)))
#+end_src


#+name: execute-gretl-practice
#+PROPERTY: P-L08-A-airlinePass
#+BEGIN_SRC sh  :exports none  :results silent :var practica="P-L08-A-airlinePass"
rm -fr $(pwd)/$practica
mkdir -p $(pwd)/$practica 
DIRECTORIO="$(pwd)/$practica" gretlcli -b $(pwd)/guiones/$practica.inp
# zip $practica $practica.* $practica/*
#+END_SRC

#+BEGIN_SRC gretl :tangle guiones/P-L08-A-airlinePass.inp :exports none :eval no
# ------------------------------------------------------------
# Copyright (C) 2025 Marcos Bujosa
# Licencia: GNU General Public License v3.0 o posterior
# Este código es software libre y puede ser redistribuido y/o modificado bajo los términos de la GPL.
# Ver el archivo LICENSE del repositorio para más detalles.
# ------------------------------------------------------------
#+END_SRC

#+begin_src gretl :tangle guiones/P-L08-A-airlinePass.inp :exports none :eval no
# Los dos primeros comandos son necesarios para que Gretl guarde los resultados de la práctica en el directorio de trabajo
# al ejecutar lo siguiente desde un terminal (use los nombres y ruta que correspondan)
#
#    DIRECTORIO="Nombre_Directorio_trabajo" gretlcli -b ruta/nombre_fichero_de_la_practica.inp
#
# Si esto no le funciona en su sistema, comente las siguientes dos líneas y sitúese en el directorio de trabajo de gretl
# que corresponda (configure dicho directorio de trabajo desde la ventana principal de Gretl).

string directory = getenv("DIRECTORIO")
set workdir "@directory"
#+end_src

#+LATEX: \maketitle

#+LATEX: \blfootnote{Licencia: Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0).}

# +LATEX: \vspace{-1cm}

* Número de viajeros internacionales

   | Guión: | [[https://mbujosab.github.io/Econometria-Aplicada/Practicas-html/guiones/P-L08-A-airlinePass.inp][P-L08-A-airlinePass.inp]] |

En esta práctica volvemos sobre la primera serie temporal estudiada en el curso: la serie temporal mensual correspondiente al número total de pasajeros (en miles) de vuelos internacionales de una importante aerolínea de EEUU que aparece en manual de Box & Jenkins.

*Objetivo*

1. Identificar un modelo para la serie temporal.
2. Pronosticar los datos correspondientes a los meses del último año de la muestra.

Comencemos cargando los datos:

*/~Archivo --> Abrir datos --> Archivo de muestra~/* y en la pestaña
*/~Gretl~/* seleccione =bjg=.

#+latex: {\vspace{0pt} \footnotesize \color{gray!70!black}
/o bien teclee en linea de comandos/:
#+NAME: Lectura del fichero de datos
#+begin_src gretl :tangle ./guiones/P-L08-A-airlinePass.inp :eval no
open bjg
#+end_src
#+latex: }


* Actividad 1 - Gráfico de series temporales

Obtenga la figura de la serie temporal en logaritmos =lg=.

#+latex: {\vspace{1pt} \footnotesize \color{gray!70!black} \color{gray!70!black}
#+NAME: Guardamos scatterplot como icono
#+begin_src gretl :tangle ./guiones/P-L08-A-airlinePass.inp :eval no 
gnuplot lg --time-series --with-lines  --output="log_AP.png"
#+end_src
#+latex: }

#+BEGIN_CENTER
#+attr_org: :width 500
#+attr_hmlt: :width 500
#+ATTR_LATEX: :width 0.45\textwidth :center t
[[./P-L08-A-airlinePass/log_AP.png]]
#+END_CENTER


* Actividad 2 - Identificar un modelo ARIMA para la serie temporal

En su momento ya vimos que esta serie requiere una diferencia regular y otra estacional.

** Correlograma de los datos tras una diferencia regular y otra estacional

Ajuste un modelo ARIMA con constante; es decir sin parte AR ni parte MA, pero indicando una diferencia regular y otra estacional sobre =lg=.

#+NAME: Modelo 0
#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports code 
arima 0 1 0 ; 0 1 0 ; lg
#+end_src

#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports none :noweb yes
outfile --quiet Modelo0.txt
  <<Modelo 0>>
end outfile
#+end_src

#+include: ./P-L08-A-airlinePass/Modelo0.txt example

Vemos que la constante no es significativa, por lo que omitiremos la constante en los próximos modelos ajustados a los datos. 

*** Analice el correlograma de los residuos hasta el retardo 36.

#+NAME: Model0
#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports code 
residuosModelo0 = $uhat
corrgm residuosModelo0 36 --plot="residuosModelo0-ACF-PACF.png"
#+end_src

#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports none :noweb yes
outfile --quiet CorrelogramaModelo0.txt
  corrgm residuosModelo0 36 --quiet
end outfile
#+end_src

#+BEGIN_CENTER
#+attr_org: :width 500
#+attr_hmlt: :width 500
#+ATTR_LATEX: :width 0.45\textwidth :center t
[[./P-L08-A-airlinePass/residuosModelo0-ACF-PACF.png]]
#+END_CENTER


#+latex: {\vspace{1pt} \footnotesize \color{gray!70!black}
#+include: ./P-L08-A-airlinePass/CorrelogramaModelo0.txt example
#+latex: }

Si nos fijamos en los retardos estacionales constatamos que:
- En la ACF son significativos el 12, pero no el 24 ni el 36.
- En la PACF son significativos el 12 y el 36.
Esto sugiere un truncamiento en la ACF en la parte de su estructura estacional (tras el primer retardo estacional), pero no el la PACF. A la luz de esto, probemos con un MA(1) estacional sin término constante.

** Probando con un MA(1) estacional

#+NAME: Modelo 1
#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports code 
arima 0 1 0 ; 0 1 1 ; lg --nc
#+end_src

#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports none :noweb yes
outfile --quiet Modelo1.txt
  <<Modelo 1>>
end outfile
#+end_src

#+include: ./P-L08-A-airlinePass/Modelo1.txt example

El parámetro $\Theta_1$ es muy significativo. La raíz de media móvil tiene módulo claramente mayor que uno. Con solo un parámetro el ajuste es notable como se puede apreciar por el R-cuadrado.

Analicemos el correlograma de los residuos hasta el retardo 36 para ver si queda alguna estructura dinámica en los residuos.

*** Correlograma de los residuos

#+NAME: Model0
#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports code 
residuosModelo1 = $uhat
corrgm residuosModelo1 36 --plot="residuosModelo1-ACF-PACF.png"
#+end_src

#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports none :noweb yes
outfile --quiet CorrelogramaModelo1.txt
  corrgm residuosModelo1 36 --quiet
end outfile
#+end_src

#+BEGIN_CENTER
#+attr_org: :width 500
#+attr_hmlt: :width 500
#+ATTR_LATEX: :width 0.45\textwidth :center t
[[./P-L08-A-airlinePass/residuosModelo1-ACF-PACF.png]]
#+END_CENTER


#+latex: {\vspace{1pt} \footnotesize \color{gray!70!black}
#+include: ./P-L08-A-airlinePass/CorrelogramaModelo1.txt example
#+latex: }

Si nos fijamos en los retardos estacionales, ninguno es significativo ni el la ACF ni en la PACF.

En cuanto a la parte regular del modelo: en el correlograma se aprecia que el primer retardo es significativo tanto en la ACF como en la PACF. 
No es fácil detectar una estructura clara en los retardos restantes.
Aunque el cuarto retardo de la PACF es significativo, no es fácil decidir si la ACF, la PACF o ambas tienen un decaimiento exponencial. 
Pudiera ocurrir que debido a la reducida magnitud del valor de los parámetros AR(1) o MA(1) regulares el decaimiento fuera tan rápido que su detección visual resulte difícil.

Dado que no hay una evidencia muy clara, empecemos probando tentativamente con un polinomio autoregresivo de orden 1 y analicemos qué tal funciona el nuevo modelo.

** Probando con un AR(1) regular (además del MA(1) estacional)

#+NAME: Modelo 2
#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports code 
arima 1 1 0 ; 0 1 1 ; lg --nc
#+end_src

#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports none :noweb yes
outfile --quiet Modelo2.txt
  <<Modelo 2>>
end outfile
#+end_src

#+include: ./P-L08-A-airlinePass/Modelo2.txt example

Los parámetros son muy significativos y si comparamos el R-cuadrado ajustado, así como los criterios de información entre el modelo anterior y eśte último. Este nuevo modelo parece superior.

Ahora analicemos el correlograma de los residuos (puesto que ya no hay restos de estacionalidad, bastará con mirar los primeros retardos).

*** Correlograma de los residuos

#+NAME: Model0
#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports code 
residuosModelo2 = $uhat
corrgm residuosModelo2 12 --plot="residuosModelo2-ACF-PACF.png"
#+end_src

#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports none :noweb yes
outfile --quiet CorrelogramaModelo2.txt
  corrgm residuosModelo2 12 --quiet
end outfile
#+end_src

#+BEGIN_CENTER
#+attr_org: :width 500
#+attr_hmlt: :width 500
#+ATTR_LATEX: :width 0.45\textwidth :center t
[[./P-L08-A-airlinePass/residuosModelo2-ACF-PACF.png]]
#+END_CENTER


#+latex: {\vspace{1pt} \footnotesize \color{gray!70!black}
#+include: ./P-L08-A-airlinePass/CorrelogramaModelo2.txt example
#+latex: }


Los p-valores de los estadísticos Q de Ljung-Box son elevados, no hay retardos significativos ni en la ACF ni en la PACF, y ambas funciones muestran un perfil muy similar. Por tanto, parece que los residuos del modelo son ruido blanco. 

Pero estaba claro el motivo por el que probar con un AR(1) regular en lugar de una MA(1) regular (máxime cuando la PACF tenía un cuarto retardo significativo).

Probemos tentativamente a añadir un polinomio MA de orden 1 (en lugar del polinomio AR).

** Probando con un MA(1) regular (además del MA(1) estacional)

#+NAME: Modelo 3
#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports code 
arima 0 1 1 ; 0 1 1 ; lg --nc
#+end_src

#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports none :noweb yes
outfile --quiet Modelo3.txt
  <<Modelo 3>>
end outfile
#+end_src

#+include: ./P-L08-A-airlinePass/Modelo3.txt example

Los parámetros son muy significativos y las raíces alejadas de círculo unidad
(el reducido valor de $\theta_1$ justifica que no se viera claramente el decaimiento de la PACF, pues dicho decaimiento es necesariamente muy rápido para potencias de =0.4=: $\;0.4,\; 0.16,\; 0.064,\ldots$).
Si nos fijamos en el R-cuadrado ajustado, así como los criterios de información, este modelo resulta superior respecto a todos los anteriores.

*** Correlograma de los residuos

#+NAME: Model0
#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports code 
residuosModelo3 = $uhat
corrgm residuosModelo3 12 --plot="residuosModelo3-ACF-PACF.png"
#+end_src

#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports none :noweb yes
outfile --quiet CorrelogramaModelo3.txt
  corrgm residuosModelo3 12 --quiet
end outfile
#+end_src

#+BEGIN_CENTER
#+attr_org: :width 500
#+attr_hmlt: :width 500
#+ATTR_LATEX: :width 0.45\textwidth :center t
[[./P-L08-A-airlinePass/residuosModelo3-ACF-PACF.png]]
#+END_CENTER


#+latex: {\vspace{1pt} \footnotesize \color{gray!70!black}
#+include: ./P-L08-A-airlinePass/CorrelogramaModelo3.txt example
#+latex: }

También este modelo arroja residuos con aspecto de ruido blanco (con retardos no significativos y perfiles de la ACF y PACF semejantes). No solo eso, además los estadísticos Q de Ljung-Box tienen p-valores más elevados que en el caso del modelo con parte AR(1) regular.

Todo indica que este modelo es mejor que cualquiera de los anteriores (pruebe más tarde con otras especificaciones e intente ver si es capaz de encontrar algún modelo claramente mejor).


* Actividad 4 - Previsión para los 12 meses de 1960

Queremos hacer previsión con este último modelo; y poder comparar sus previsiones con las observaciones correspondientes al año 1960. 
Para hacer este ejercicio, debemos estimar el modelo sin incorporar los datos de dicho año (prever algo que ya ha sido observado no tiene mérito). Dicho de otro modo, debemos usar el conjunto de información $\mathcal{H}_{Y_{1959:12}}$ de tal manera que el número de viajeros en los meses de 1960 no sea ``observado''.

** Re-estimación del modelo truncando la muestra

Reestimaremos el modelo con datos hasta diciembre de 1959 
#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports code 
smpl 1949:01 1959:12
arima 0 1 1 ; 0 1 1 ; lg --nc
#+end_src

** Previsión de los 12 últimos meses de la muestra

#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports code 
fcast 1959:01 1960:12 --plot="prediccion1960.png"
#+end_src


#+BEGIN_CENTER
#+attr_org: :width 500
#+attr_hmlt: :width 500
#+ATTR_LATEX: :width 0.45\textwidth :center t
[[./P-L08-A-airlinePass/prediccion1960.png]]
#+END_CENTER


#+begin_src R :tangle guiones/P-L08-A-airlinePass.inp :results none :exports none :noweb yes
outfile --quiet Predicciones.txt
  fcast --out-of-sample
end outfile
#+end_src

#+latex: {\vspace{1pt} \footnotesize \color{gray!70!black}
#+include: ./P-L08-A-airlinePass/Predicciones.txt example
#+latex: }

Pruebe con otras especificaciones e intente ver si es capaz de encontrar algún modelo mejor tanto por el ajuste como por los errores cometidos con sus predicciones.

* Código completo de la práctica

#+latex: {\vspace{10pt}
#+latex: \noindent
[[https://mbujosab.github.io/Econometria-Aplicada/Practicas-html/guiones/P-L08-A-airlinePass.inp][P-L08-A-airlinePass.inp]]
#+latex: \vspace{10pt}
#+LATEX: \lstinputlisting{guiones/P-L08-A-airlinePass.inp}
#+LATEX: \clearpage }
