#+TITLE: Publicaci√≥n de los ficheros org en GitHub pages
#+author: Marcos Bujosa
#+LANGUAGE: es

# +OPTIONS: toc:nil

#+TAGS: noexport
#+EXCLUDE_TAGS: noexport

#+startup: shrink

# ###########
# ESTO DA EL FORMATO FINAL DE LA P√ÅGINA WEB V√âASE [[https://olmon.gitlab.io/org-themes/]]
#+SETUPFILE: ../css/readtheorg_inline.theme
# ###########

#+LATEX_HEADER_EXTRA: \usepackage{fullpage}


#+LATEX_HEADER_EXTRA: \usepackage[spanish]{babel}
#+LATEX_HEADER_EXTRA: \usepackage{lmodern}
#+LATEX_HEADER_EXTRA: \usepackage{tabularx}
#+LATEX_HEADER_EXTRA: \usepackage{booktabs}

#+BEGIN_SRC emacs-lisp :exports none :results silent :tangle no :eval yes
(unless (file-directory-p "docs")
  (make-directory "docs"))
(unless (file-directory-p "docs/.binder")
  (make-directory "docs/.binder"))
#+END_SRC


#+LATEX: \maketitle

* Fichero =makefile=

Genera el directorio =docs= con los ficheros para GitPages con subdirectorios para los =CuadernosElectronicos=, =pdfs=, =Transparencias= y los ficheros con las lecciones en ~html~.

#+BEGIN_SRC makefile :noweb no-export :results silent :tangle makefile
LECCIONES_SRC = ./org-lessons
LECCIONES_tmp = ./Lecciones-tmp
PRACTICAS_SRC = ./org-practicas
PRACTICAS_tmp = ./Practicas-tmp
DOCS = ./docs
CUADERNOS = $(DOCS)/CuadernosElectronicos
TRANSPARENCIAS = $(DOCS)/Transparencias

SRC_FILES = $(LECCIONES_SRC)/*.org
# SRC_FILES = $(LECCIONES_SRC)/Lecc*.org
# SRC_PRACTICAS_PYTHON_FILES = $(LECCIONES_SRC)/P-L.org

#.PHONY: cleanAll directorios programas_de_python calendario notebooksYslides limpia_kernels_jupyter practicas publicacion limpia_kernels_jupyter

all: calendario notebooksYslides practicas  publicacion-lecciones publicacion-practicas publicacion limpia_kernels_jupyter

calendario: directorios $(DOCS)/Calendario-Econometria-Aplicada.pdf

$(DOCS)/Calendario-Econometria-Aplicada.pdf:
	emacs --batch Calendario/README.org -l org -f org-babel-tangle
	cd Calendario && make Calendario-Econometria-Aplicada.pdf

publicacion:
	cp -a README.org  $(DOCS)
	mkdir -p $(DOCS)/Practicas-html/img
	find . -wholename $(LECCIONES_tmp)/P-L*.pdf -exec cp {} $(DOCS)/Practicas-pdf/ \;
	find . -wholename $(LECCIONES_tmp)/P-L*.html -exec cp {} $(DOCS)/Practicas-html/ \;
	cp -a $(DOCS)/Lecciones-html/img/P-L* $(DOCS)/Practicas-html/img/
	cp -a $(DOCS)/Lecciones-html/P-L*.html $(DOCS)/Practicas-html/
#	find $(DOCS)/Lecciones-html/img/ -maxdepth 1 -type d -name "P-L*" -exec cp -a {}  $(DOCS)/Practicas-html/img/ \;
#	find $(DOCS)


# Defino las rutas de origen y destino para mayor claridad
SRC_IMG = $(DOCS)/Lecciones-html/img/ 
DST_IMG = $(DOCS)/Practicas-html/img/

# Para crear los enlaces simb√≥licos de las pr√°cticas en Python
img_symlink_files:
	files=$(shell find $(SRC_IMG) -name *.png); \
	for file in $$files; do \
		if [ -e "$$file" ]; then \
			base_name=$$(basename "$$file" .png); \
			echo "Procesando archivo: $$file"; \
			ln -snf ../$$file "$(DST_IMG)$$base_name.png"; \
			echo "Enlace creado: $(DST_IMG)$$base_name.png -> ../$$file"; \
		else \
			echo "Archivo: $$file no existe"; \
		fi; \
	done


publicacion-lecciones: $(patsubst $(LECCIONES_SRC)/%.org,$(CUADERNOS)/%.ipynb,$(wildcard $(SRC_FILES))) README.org index.org
	echo "FICHEROS EN CuadernosElectronicos y Transparencias?..."
	cp -a $(LECCIONES_tmp)/Lecc*.slides.html $(TRANSPARENCIAS)
	find . -wholename $(LECCIONES_tmp)/P-L*.slides.html -exec cp {} $(TRANSPARENCIAS)/ \;
#	#cp -a $(LECCIONES_tmp)/P-L*.slides.html $(TRANSPARENCIAS)
	ls $(CUADERNOS)
	ls $(TRANSPARENCIAS)
	echo "EJECUCI√ìN DE publica.el..."
	emacs --batch \
	  --load ~/Software/scimax/init.el \
	  -l publica.el
	touch $@
#	echo "FICHEROS EN Docs?..."
#	find $(DOCS)/Lecciones-html
#	find $(DOCS)/Lecciones-pdf

publicacion-practicas: $(patsubst $(PRACTICAS_SRC)/%.org,$(CUADERNOS)/%.ipynb,$(wildcard $(SRC_FILES))) README.org index.org
	echo "EJECUCI√ìN DE publica-practicas.el..."
	emacs --batch \
	  --load ~/Software/scimax/init.el \
	  -l publica-practicas.el
	echo "FICHEROS EN Docs?..."
	touch $@
#	find $(DOCS)/Practicas-html
#	find $(DOCS)/Practicas-pdf


notebooksYslides: $(patsubst $(LECCIONES_SRC)/%.org,$(CUADERNOS)/%.ipynb,$(wildcard $(SRC_FILES)))
	touch $@
#	pkill -f "python3 -m ipykernel_launcher"

$(CUADERNOS)/%.ipynb $(TRANSPARENCIAS)/%.slides.html: $(LECCIONES_SRC)/%.org
	make directorios
	make programas_de_python
#	make symlink_files
	cp -a $(LECCIONES_SRC)/*.bib $(LECCIONES_tmp)
	cp -a $< $(LECCIONES_tmp)
	echo "EJECUCION DEL NOTEBOOK DE ORG: $(LECCIONES_tmp)/$(@F:.ipynb=.org)..."
	emacs -Q -l ~/Software/scimax/init.el $(LECCIONES_tmp)/$(@F:.ipynb=.org) --batch --eval "(org-babel-execute-buffer)" --eval "(save-buffer)" --kill
	cp -a $(LECCIONES_tmp)/$(@F) $(CUADERNOS)
	echo "EJECUCION DEL NOTEBOOK DE JUPYTER..."
	jupyter nbconvert --execute --inplace $(LECCIONES_tmp)/$(@F) 
	echo "FICHEROS EN ./lecciones?..."
#	find $(LECCIONES_tmp)
	echo "FICHEROS EN ./docs/Lecciones-html/img?..."
	cp -a $(LECCIONES_tmp)/img $(DOCS)/Lecciones-html
#	find $(DOCS)/Lecciones-html/img
	echo "Contenido de img tras notebook:"
#	find $(LECCIONES_tmp)/img
	echo "COPIO LO QUE SE HA GENERADO (.ipynb sin ejecutar y las im√°genes) A ./docs..."
	ln -snf -r $(DOCS)/Lecciones-html/img/ $(TRANSPARENCIAS)/
	ln -snf -r $(DOCS)/Lecciones-html/img/ $(CUADERNOS)/
#	# Ejecutar el notebook con jupyter nbconvert
	echo "CREACI√ìN DE LAS SLIDES..."
	jupyter nbconvert --config mycfg-GitHubPages.py --to slides --reveal-prefix "https://unpkg.com/reveal.js@5.2.1" --execute $(LECCIONES_tmp)/$(@F) 
	echo "‚û°Ô∏è FICHEROS EN docs/ TRAS GENERAR SLIDES Y NOTEBOOKS DE JUPYTER..."
#	find $(DOCS)



# Define las rutas de origen y destino para mayor claridad
SRC_DIR_PRACTICAS =./org-practicas/     # ./org-practicas/
DST_DIR_PRACTICAS =./org-lessons/

# Para crear los enlaces simb√≥licos de las pr√°cticas en Python
symlink_files:
	files=$(shell find $(SRC_DIR_PRACTICAS) -name *.txt); \
	for file in $$files; do \
		if [ -e "$$file" ]; then \
			base_name=$$(basename "$$file" .txt); \
			echo "Procesando archivo: $$file"; \
			ln -snf ../$$file "$(DST_DIR_PRACTICAS)$$base_name.org"; \
			echo "Enlace creado: $(DST_DIR_PRACTICAS)$$base_name.org -> ../$$file"; \
		else \
			echo "Archivo: $$file no existe"; \
		fi; \
	done



# Lista de archivos fuente .org en org-practicas
PRACTICAS_SRC = $(wildcard org-practicas/*.org)

# Ficheros .done como se√±al de que fueron tanglados
PRACTICAS_DONE = $(patsubst org-practicas/%.org, $(PRACTICAS_tmp)/%.done, $(PRACTICAS_SRC))

# Objetivo principal de las pr√°cticas en Gretl
practicas: $(PRACTICAS_DONE)
	@echo "‚úÖ Todas las pr√°cticas actualizadas."

$(PRACTICAS_tmp)/%.done: org-practicas/%.org
	echo "‚û°Ô∏è Copiando y ejecutando $< ..."
	mkdir -p $(PRACTICAS_tmp)/guiones
	cp $< $(PRACTICAS_tmp)/
	mkdir -p $(PRACTICAS_tmp)/src
	cp $(LECCIONES_tmp)/src/*.py $(PRACTICAS_tmp)/src
	ln -snf -r $(LECCIONES_tmp)/datos $(PRACTICAS_tmp)/
	cp -a org-practicas/hansl.tex $(PRACTICAS_tmp)/
	echo "üß† Ejecutando org-babel-tangle y eval..."
	set -e; \
	if emacs --batch \
	  --load ~/Software/scimax/init.el \
	  $(PRACTICAS_tmp)/$*.org \
	  --eval "(org-babel-execute-buffer)" \
	  --eval "(save-buffer)" \
	  --kill; then \
	    echo "‚úÖ Correcto: $<"; \
	    touch $@; \
	else \
	    echo "‚ùå Error al procesar $<"; \
	    rm -f $@; \
	    exit 1; \
	fi
	echo "‚û°Ô∏è listado de ficheros en el subdirectorio guiones"
	ls -lR $(PRACTICAS_tmp)/guiones  # Debug para Actions


ORG_FILES := $(wildcard $(LECCIONES_SRC)/src/*.org)
TMP_FILES := $(patsubst $(LECCIONES_SRC)/src/%.org, $(LECCIONES_tmp)/src/%.org, $(ORG_FILES))

programas_de_python: $(TMP_FILES)

$(LECCIONES_tmp)/src/%.org: $(LECCIONES_SRC)/src/%.org
	echo "INICIO $*.ipynb..."
	make directorios
	cp $< $(LECCIONES_tmp)/src/
	emacs -q --batch $(LECCIONES_tmp)/src/$*.org -l org -f org-babel-tangle
	cp -a $(LECCIONES_tmp)/src/$*.py $(CUADERNOS)/src/
	ln -sf -r $(CUADERNOS)/src/$*.py $(CUADERNOS)/
	emacs -Q -l ~/Software/scimax/init.el $(LECCIONES_tmp)/$(@F:.ipynb=.org) --batch --eval "(org-babel-execute-buffer)" --eval "(save-buffer)" --kill
	#emacs -q --batch \
	#  --load ~/Software/scimax/init.el \
	#  --eval "(require 'ox-ipynb)" \
	#  --eval "(ox-ipynb-export-org-file-to-ipynb-file \"$(LECCIONES_tmp)/src/$*.org\")"
	#jupyter nbconvert --execute --inplace $(LECCIONES_tmp)/src/$*.ipynb
	#jupyter nbconvert --config mycfg-GitHubPages.py --to slides --reveal-prefix "https://unpkg.com/reveal.js@5.2.1" --execute $(LECCIONES_tmp)/src/$*.ipynb
	#jupyter nbconvert --execute --to html $(LECCIONES_tmp)/src/$*.ipynb
	cp -a $(LECCIONES_tmp)/src/$*.ipynb $(CUADERNOS)
	cp -a $(LECCIONES_tmp)/src/$*.slides.html $(TRANSPARENCIAS)
	cp -a $(LECCIONES_tmp)/src/$*.html $(DOCS)/Lecciones-html/src/
	echo "TERMINADO $*.ipynb..."

directorios:
	mkdir -v -p .github/workflows
	mkdir -v -p $(LECCIONES_tmp)/src
	mkdir -v -p $(LECCIONES_tmp)/img
	mkdir -v -p $(DOCS)/Lecciones-pdf
	mkdir -v -p $(DOCS)/.binder
	mkdir -v -p $(DOCS)/Lecciones-html/img
	mkdir -v -p $(DOCS)/Lecciones-html/src
	mkdir -v -p $(TRANSPARENCIAS)
	mkdir -v -p $(CUADERNOS)/src
	cp -a ./css $(LECCIONES_tmp)/
	cp -a ./datos $(LECCIONES_tmp)/
	cp -a ./datos $(DOCS)/
	touch directorios

clean:
	rm -r -f $(LECCIONES_tmp)
	rm -r -f $(PRACTICAS_tmp)

cleanAll: clean
	#find $(DOCS)/ -mindepth 1 ! -name 'README.org' ! -name '.binder' -exec rm -rf {} +
	rm -r -f $(DOCS)
	rm -f directorios
	rm -f series_formales
	rm -f publicacion-lecciones
	rm -f publicacion-practicas
	rm -f practicas
	rm -f notebooksYslides
	rm -f sitemap.org
	rm -r -f logs

limpia_kernels_jupyter:
	pkill -f "python3 -m ipykernel_launcher"
	# pkill -f "python3 -m ipykernel_launcher -f /home/marcos/.local/share/jupyter/runtime/kernel-.*\.json"

#+END_SRC

** Aclaraciones

El directorio =./Lecciones-tmp= es temporal (en el fichero ~makefile~ se hace referencia a √©l con =$(LECCIONES_tmp)=). En dicho directorio se ejecutan los notebooks. Los ficheros creados se copian en distintos subdirectorios del directorio de publicaci√≥n =./docs= (en el fichero ~makefile~ es referenciado con =$(DOCS)= ). El subdirectorio =./docs= es el directorio de donde "cuelgan" las p√°ginas web; dichas p√°ginas se distribuyen desde la rama =gh-pages= del repositorio.


* Fichero =build.yml=

Contiene las instrucciones que ejecutar√° GitHub Actions en el repositorio cada vez que √©ste sea actualizado.

Usa el contenido (los ficheros fuente) de la rama =main= y copia los ficheros compilados en la ra√≠z de la rama =gh-pages=. 
#+BEGIN_SRC yml :tangle .github/workflows/build.yml
name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3


    - name: Checkout del repositorio de datos
      uses: actions/checkout@v4
      with:
        repository: mbujosab/TimeSeriesData
        path: datos_temp

    - name: Copiar archivos de datos del repositorio de datos al directorio datos
      run: |
        rm -rf econometria-aplicada/datos      # Elimina el antiguo directorio datos (si existe)
        cp -R datos_temp econometria-aplicada/datos

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git emacs pandoc aspell aspell-en aspell-es zip gretl wget
        pip install jupyter nbconvert

    - name: Crear carpeta e instalar la base de datos del Banco de Espa√±a en Gretl
      run: |
        mkdir -p ~/.gretl/db
        cp -r db/* ~/.gretl/db/

    - name: Crear carpeta e instalar arima_sim.gfn
      run: |
        mkdir -p ~/.gretl/functions
        wget -O ~/.gretl/functions/arima_sim.gfn https://gretl.sourceforge.net/current_fnfiles/arima_sim.gfn	

    - name: Install Python modules
      run: |
        pip install sympy numpy pandas matplotlib dataframe-image statsmodels seaborn scipy

    - name: Exportar backend matplotlib
      run: echo "MPLBACKEND=Agg" >> $GITHUB_ENV

    - name: Verify Jupyter Installation
      run: |
        jupyter kernelspec list

    - name: Install LaTeX
      run: |
        sudo apt-get install -y texlive  texlive-latex-recommended texlive-latex-extra  texlive-fonts-extra texlive-fonts-recommended texlive-xetex texlive-science python3-pygments texlive-lang-spanish texlive-bibtex-extra texlive-binaries texlive-extra-utils texlive-font-utils texlive-luatex texlive-xetex dvipng

    - name: Disable tlmgr (prevent accidental calls)
      run: sudo mv /usr/bin/tlmgr /usr/bin/tlmgr.disabled || true

    - name: Clone Scimax
      run: |
        git clone https://github.com/jkitchin/scimax.git ~/Software/scimax

    - name: Download ox-ipynb.el
      run: |
        wget https://raw.githubusercontent.com/jkitchin/ox-ipynb/master/ox-ipynb.el -O ~/Software/scimax/ox-ipynb.el

    - name: Install s.el and dash.el
      run: |
        emacs --batch --eval "(require 'package)" \
                      --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\"))" \
                      --eval "(package-refresh-contents)" \
                      --eval "(package-install 's)" \
                      --eval "(package-install 'dash)"

    - name: Create no-tlmgr.el
      run: |
        mkdir -p ~/.emacs.d
        echo "(setq system-packages-use-sudo nil)" > ~/.emacs.d/no-tlmgr.el
        echo "(setq TeX-install-font-lock nil)" >> ~/.emacs.d/no-tlmgr.el
        echo "(setq TeX-live-install-texmf nil)" >> ~/.emacs.d/no-tlmgr.el

    - name: Verify ox-ipynb Installation
      run: |
        emacs --batch \
              --eval "(add-to-list 'load-path \"~/Software/scimax/\")" \
              --eval "(dolist (dir (directory-files \"~/.emacs.d/elpa/\" t \"^[^.]\")) (add-to-list 'load-path dir))" \
              --eval "(require 'ox-ipynb)"

    - name: Create .binder directory
      run: mkdir -p docs/.binder

    - name: Ficheros de configuracion
      run: |
        emacs --batch org-publish.org -l org -f org-babel-tangle

    - name: Execute Makefile notebooksYslides
      run: |
        set -e
        make notebooksYslides

    - name: Inspecci√≥n tras notebooksYslides
      run: |
        echo "Contenido de ./Lecciones-tmp:"
        find ./Lecciones-tmp
        echo "Contenido de ./docs:"
        find ./docs

    - name: Execute Makefile practicas
      run: |
        set -e
        make practicas
        echo "Contenido de ./Practicas-tmp:"
        find ./Practicas-tmp

    - name: Execute Makefile calendario
      run: |
        set -e
        make calendario

    - name: Execute Makefile publicacion-lecciones
      run: |
        set -e
        make publicacion-lecciones

    - name: Execute Makefile publicacion-practicas
      run: |
        set -e
        make publicacion-practicas

    - name: Execute Makefile publicacion
      run: |
        set -e
        make publicacion

    - name: Comprobar contenido de docs antes de deploy
      run: |
        echo "Contenido de docs antes de deploy:"
        ls -la docs

    - name: Deploy docs/ a gh-pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.NUEVO_TOKEN_CLASSIC_HASTA_JULIO_2026 }}
        publish_dir: ./docs
        publish_branch: gh-pages
#        force_orphan: true
#        allow_empty_commit: true
#+END_SRC
# NUEVO_TOKEN_CLASSIC_HASTA_JULIO_2026

** Aclaraciones

**** tlmgr
Scimax intenta usar ~tlmgr~ para instalar paquetes de $\LaTeX{}$, pero =Actions= de =GitHub= no lo permite. Las medidas tomadas para evitar este problema han sido 
1. Al ejecutarse ~.github/workflows/build.yml~ en GitHub Actions se crea un fichero =~/.emacs.d/no-tlmgr.el= con el siguiente contenido
   #+BEGIN_SRC 
(setq system-packages-use-sudo nil)
(setq TeX-install-font-lock nil)
   #+END_SRC
   as√≠, al publicar los ficheros, podemos llamar a scimax del siguiente modo
   #+BEGIN_SRC 
emacs --batch \
  --load ~/.emacs.d/no-tlmgr.el \
  --load ~/Software/scimax/init.el \
  -l publica.el
   #+END_SRC
2. Adem√°s en ~.github/workflows/build.yml~ he a√±adido
   #+BEGIN_SRC 
    - name: Disable tlmgr (prevent accidental calls)
      run: sudo mv /usr/bin/tlmgr /usr/bin/tlmgr.disabled || true
   #+END_SRC

Quiz√° sea suficiente solo con esto segundo. Pero si quito el fichero =~/.emacs.d/no-tlmgr.el=, tambi√©n he de omitirlo en las llamadas a emacs usando scimax (como as√≠ funciona... as√≠ se queda).

*** Consulta a Copilot sobre la generaci√≥n de figuras

Tuve dificultades para que la ejecuci√≥n en GitHub Actions de los de los cuadernos electr√≥nicos de Scimax creara las figuras. A continuaci√≥n copio mi consulta a copilot: 

#+BEGIN_QUOTE
-----
-----
*/Consulta/*:
/Anteriormente faltaba por instalar el paquete dvipng. Una vez instalado dvipng, el bloque de c√≥digo/:

#+BEGIN_SRC jupyter-python :results file :exports results
plt.plot([1,2,3],[4,5,6])
plt.savefig("img/prueba_action.png")
"img/prueba_action.png"
#+END_SRC

/ha creado correctamente el fichero "img/prueba_action.png" con la figura. Sin embargo, el bloque/

#+BEGIN_SRC jupyter-python :results file :file ./img/lecc01/PIB_UEM.png
df1.plot(x='obs',xlabel='',figsize=(15,4)).set_title('PIB zona euro',fontsize=18)
#+END_SRC

/no ha creado el fichero ./img/lecc01/PIB_UEM.png con su correspondiente figura./
-----
-----
#+END_QUOTE

¬°Excelente que la instalaci√≥n de dvipng haya solucionado la generaci√≥n de im√°genes para el primer bloque!  
Ahora, pasemos a analizar por qu√© el segundo bloque *no genera* el archivo `./img/lecc01/PIB_UEM.png`.

-----

**** Diagn√≥stico y causas probables

***** 1. Diferencia clave entre ambos bloques

- *Bloque que funciona:*

  #+BEGIN_SRC org
  #+BEGIN_SRC jupyter-python :results file :exports results
  plt.plot([1,2,3],[4,5,6])
  plt.savefig("img/prueba_action.png")
  "img/prueba_action.png"
  #+END_SRC
  #+END_SRC

  - Aqu√≠, t√∫ generas la figura y la guardas expl√≠citamente con `plt.savefig()`, y luego devuelves el nombre del archivo en la √∫ltima l√≠nea.

- *Bloque que falla:*

  #+BEGIN_SRC org
  #+BEGIN_SRC jupyter-python :results file :file ./img/lecc01/PIB_UEM.png
  df1.plot(x='obs',xlabel='',figsize=(15,4)).set_title('PIB zona euro',fontsize=18)
  #+END_SRC
  #+END_SRC

  - Aqu√≠ conf√≠as en que org-babel/jupyter-python guardar√° autom√°ticamente la figura en `:file`, pero el m√©todo pandas `df.plot()` *no guarda ni devuelve* el archivo.

***** 2. ¬øPor qu√© falla el segundo bloque?

- El argumento `:file ./img/lecc01/PIB_UEM.png` espera que el √∫ltimo comando del bloque *guarde la imagen en ese path* (o devuelva una figura que org/jupyter pueda guardar ah√≠).
- El m√©todo `df1.plot(...).set_title(...)` crea y modifica una figura activa, pero *no la guarda*.
- Si usas solo `set_title()`, no hay ninguna instrucci√≥n para guardar el gr√°fico.
- Por defecto, ni org-babel ni jupyter-python pueden adivinar que la figura debe ser guardada en ese path si no se lo indicas de forma expl√≠cita.

-----

**** Soluci√≥n recomendada

*Debes guardar la figura manualmente al path especificado*, y devolver ese path como resultado del bloque.

***** Forma correcta:

#+BEGIN_SRC jupyter-python :results file :file ./img/lecc01/PIB_UEM.png
ax = df1.plot(x='obs', xlabel='', figsize=(15,4))
ax.set_title('PIB zona euro', fontsize=18)
import matplotlib.pyplot as plt
plt.savefig("./img/lecc01/PIB_UEM.png")
"./img/lecc01/PIB_UEM.png"
#+END_SRC

- Esto asegura que la imagen se guarda donde deseas y que el bloque devuelve el path correcto para que org-babel inserte la imagen en el documento.

***** Alternativas

- Si usas solo `:results file` sin `:file`, puedes devolver el nombre del archivo en la √∫ltima l√≠nea.
- Siempre aseg√∫rate de llamar a `plt.savefig()` *despu√©s* de crear el gr√°fico.

-----

**** Resumen

- El bloque con `plt.savefig(...)` funciona porque guarda expl√≠citamente la imagen.
- El bloque con pandas `plot` y solo `set_title()` *NO guarda la imagen*; debes a√±adir `plt.savefig()` y devolver el path.
- As√≠, org-babel/jupyter-python incrustar√° correctamente la imagen en el documento exportado.

-----

#+BEGIN_QUOTE
-----
-----
*/Consulta/*:
/Sin embargo. Cuando ejecuto localmente el fichero org s√≠ se crean las figuras en mi disco. ¬øHay alg√∫n modo de que tambi√©n se creen con Actions sin modificar los bloques? Es decir, ¬øhay alg√∫n modo de que funcionen tal y como est√°n ahora mismo?/
-----
-----
#+END_QUOTE

¬°Esta es una pregunta muy frecuente al usar org-babel/jupyter en entornos CI/CD!  
La diferencia entre tu entorno local y GitHub Actions suele deberse a *la configuraci√≥n del entorno gr√°fico* y de *matplotlib*.

-----

**** ¬øPor qu√© funciona localmente pero no en Actions?

- *Localmente*, matplotlib tiene acceso a un entorno gr√°fico (X11, Wayland, etc.) y suele usar un backend como `TkAgg`, `Qt5Agg`,‚Ä¶
- *En GitHub Actions* (o cualquier entorno headless), *matplotlib no tiene acceso a un display* y por defecto puede intentar usar un backend que requiere uno, lo que impide guardar im√°genes.

***** Backend headless necesario

Para guardar im√°genes sin display, *matplotlib debe usar un backend como "Agg"*.

-----

**** Soluci√≥n: Forzar el backend "Agg" para matplotlib

Esto se puede hacer *sin modificar los bloques* a√±adiendo una configuraci√≥n previa en tu flujo de trabajo o al comienzo de la ejecuci√≥n.

***** Opci√≥n 1: Variable de entorno en el workflow

A√±ade esto antes de ejecutar Emacs en tu `build.yml`:

#+BEGIN_SRC yaml
- name: Set MPLBACKEND (matplotlib)
  run: echo "MPLBACKEND=Agg" >> $GITHUB_ENV
#+END_SRC

Matplotlib detectar√° esto y usar√° el backend adecuado.

***** Opci√≥n 2: Variable de entorno en shell

O directamente en el comando de ejecuci√≥n:

#+BEGIN_SRC bash
MPLBACKEND=Agg emacs -Q -l ~/Software/scimax/init.el ./lecciones/Lecc01.org --batch ...
#+END_SRC

***** Opci√≥n 3: Configuraci√≥n en Emacs/jupyter-python

Si puedes modificar la configuraci√≥n de Emacs que se carga, a√±ade a tu init.el o a la cabecera de los bloques:

#+BEGIN_SRC python
import matplotlib
matplotlib.use("Agg")
#+END_SRC

Pero esto requerir√≠a modificar los bloques, que quieres evitar.

-----

**** Resumen

- *El problema*: matplotlib necesita el backend "Agg" para funcionar headless.
- *La soluci√≥n sin modificar los bloques*: establece la variable de entorno `MPLBACKEND=Agg` en el workflow antes de ejecutar Emacs.
- *As√≠*, los bloques que generan im√°genes funcionar√°n igual en Actions que localmente, *sin necesidad de cambiar el c√≥digo de los bloques*.

-----
-----
-----
*/SOLUCI√ìN FINALMENTE ADOPTADA/*:

El backend "Agg"  no me funcion√≥, por lo que opt√© por indicar expl√≠citamente en el c√≥digo de python el fichero donde se debe guardar cada figura.
-----
-----
-----


*** Consulta sobre los n√∫cleos de Jupyter

Cuando ejecuto Actions en GitHub y Actions ejecuta un notebook de jupyter ¬øEn qu√© directorio lo hace? Me gustaria matar los procesos  python3 -m ipykernel_launcher tras ejecutar los notebooks

**** Respuesta

Cuando GitHub Actions ejecuta un notebook de Jupyter, lo hace en un entorno temporal que se crea para cada ejecuci√≥n de la acci√≥n. Usualmente, el directorio de trabajo es el que se especifica en el archivo de configuraci√≥n (`.yml`) de la acci√≥n, com√∫nmente en el directorio del repositorio.

Si deseas matar los procesos de Jupyter despu√©s de que se ejecute un notebook en GitHub Actions, puedes agregar un paso en tu flujo de trabajo (workflow) que use un comando como `pkill` para terminar los procesos de Jupyter, tal como:

```yaml
- name: Kill Jupyter processes
  run: pkill -f "python3 -m ipykernel_launcher"
```

Sin embargo, ten en cuenta que los entornos de GitHub Actions se eliminan despu√©s de que una ejecuci√≥n finaliza, por lo que normalmente no es necesario matar procesos manualmente al final del trabajo.

*** GitHub tokens

Para solucionar el error de autenticaci√≥n debido a un token de GitHub caducado y usar un nuevo token, sigue estos pasos:

1. Genera un nuevo personal access token (PAT)
Ve a tu perfil de GitHub > Settings > Developer settings > Personal access tokens.
Haz clic en ‚ÄúGenerate new token‚Äù.
Selecciona los scopes necesarios. Para subir a GitHub Pages y realizar pushes, selecciona:
repo (para acceso completo a los repositorios privados/p√∫blicos)
workflow (si tu workflow lo requiere)
Copia el token generado (no podr√°s verlo de nuevo).


2. Guarda el nuevo token en los Secrets del repositorio
Ve al repositorio: https://github.com/mbujosab/Econometria-Aplicada
Settings > Secrets and variables > Actions.
Haz clic en ‚ÄúNew repository secret‚Äù.
Nombra el secret, por ejemplo: GH_TOKEN o PERSONAL_TOKEN.
Pega el token generado y guarda.
3. Actualiza tu workflow para usar el nuevo token
En tu archivo .github/workflows/build.yml (o el que corresponda), aseg√∫rate de que el paso que hace git push o usa el token est√© as√≠:

YAML
- name: Push to GitHub Pages
  run: git push origin gh-pages
  env:
    GITHUB_TOKEN: ${{ secrets.GH_TOKEN }} # O el nombre que hayas puesto
O, si usas una acci√≥n como peaceiris/actions-gh-pages:

YAML
- name: Deploy to GitHub Pages
  uses: peaceiris/actions-gh-pages@v3
  with:
    github_token: ${{ secrets.GH_TOKEN }}
4. Confirma que el token tiene los permisos adecuados
El token debe tener acceso de escritura al repo.
Si usas una acci√≥n (como actions/checkout o actions-gh-pages), aseg√∫rate de pasar el secret correcto.



* Script =publica.el= de elisp para publicar las lecciones con formato =.org= como ficheros con formato =pdf= y ~html~

Este script transforma los ficheros org de las lecciones en pdfs y htmls. 

#+BEGIN_SRC  emacs-lisp :tangle publica.el :results silent
;;; publica.el --- Publicaci√≥n HTML y PDF para el repositorio Scimax-ELN

(require 'ox-publish)

(setq org-confirm-babel-evaluate nil
      org-export-with-broken-links t
      org-html-validation-link nil
      org-html-head-include-scripts nil
      org-html-head-include-default-style nil)

(defun my-org-latex-publish-to-pdf (plist filename pub-dir)
  "Publica un archivo Org como PDF tras ejecutar bloques de c√≥digo."
  (message "Exportando a PDF: %s" filename)
  (with-current-buffer (find-file-noselect filename)
    (org-babel-execute-buffer)
    (sleep-for 25)
    (save-buffer)
    (org-latex-publish-to-pdf plist filename pub-dir)))

;; (defun my-org-html-publish-to-html (plist filename pub-dir)
;;   "Publica un archivo Org como PDF tras ejecutar bloques de c√≥digo."
;;   (message "Exportando a html: %s" filename)
;;   (with-current-buffer (find-file-noselect filename)
;;     (org-babel-execute-buffer)
;;     (sleep-for 20)
;;     (org-html-publish-to-html plist filename pub-dir)))

(let* ((base-directory "./"))
  (setq org-publish-project-alist
        (append org-publish-project-alist
                `(("index"
                   :base-directory ,base-directory
                   :base-extension "org"
                   :publishing-directory ,(concat base-directory "docs")
                   :exclude "src\\|Calendario\\|org-lessons\\|org-practicas\\|docs\\|Lecciones-tmp\\|Practicas-tmp\\|org-publish.org\\|README.org\\|CriteriosEvaluacion.org"
                   :recursive t
                   :publishing-function org-html-publish-to-html
                   :auto-preamble t
                   :auto-sitemap nil
                   :with-author nil
                   :with-creator nil
                   :with-toc t
                   :section-numbers nil)

                  ("pdf"
                   :base-directory "./Lecciones-tmp/"
                   :base-extension "org"
                   :publishing-directory ,(concat base-directory "docs/Lecciones-pdf")
                   :exclude "src\\|README.org\\|sitemap.org"
                   :recursive t
                   :auto-sitemap nil
                   :publishing-function my-org-latex-publish-to-pdf
                   :auto-preamble t)
		  
                  ("html"
                   :base-directory  "./Lecciones-tmp/"
                   :base-extension "org"
                   :publishing-directory ,(concat base-directory "docs/Lecciones-html")
                   :exclude "src\\|README.org"
                   :recursive t
                   :publishing-function org-html-publish-to-html ; my-org-html-publish-to-html ; 
                   :auto-preamble t
                   :auto-sitemap t
                   :with-author nil
                   :with-creator nil
                   :with-toc t
                   :section-numbers nil)

                  ("static-index"
                   :base-directory ,base-directory
                   :base-extension "css\\|js\\|png\\|jpg\\|gif\\|dat\\|mov\\|txt\\|svg\\|aiff\\|inp"
                   :publishing-directory ,(concat base-directory "docs")
                   :exclude "src\\|Calendario\\|org-lessons\\|org-practicas\\|Lecciones-tmp\\|Practicas-tmp\\|docs\\|org-publish.*\\|README.org\\|CriteriosEvaluacion.org"
                   :recursive t
                   :publishing-function org-publish-attachment)

                  ("web-repositorio" :components ("index" "pdf" "html" "static-index")))))

  (message "üü¢ Iniciando publicaci√≥n del √≠ndice (web-repositorio)...")
  (org-publish "web-repositorio" t)
  (message "‚úÖ Publicaci√≥n del √≠ndice completada."))

#+END_SRC

# (unless (file-directory-p "logs")
#   (make-directory "logs"))
# (with-temp-file "logs/publica.log"
#   (insert (format "Publicado el %s\n" (current-time-string))))

Podemos chequear la versi√≥n local ejecutando en emacs el siguiente bloque

#+BEGIN_SRC emacs-lisp :results silent
(browse-url "docs/index.html")
#+END_SRC


* Script =publica-practicas.el= de elisp para publicar las pr√°cticas con formato =.org= como ficheros con formato =pdf= y ~html~

Este script transforma los ficheros org de las lecciones en pdfs y htmls. 

#+BEGIN_SRC  emacs-lisp :tangle publica-practicas.el :results silent
;;; publica.el --- Publicaci√≥n HTML y PDF de las pr√°cticas para el repositorio


;; Lo siguiente es para que se vean en pdf los bloques de c√≥digo hanls
;; A√±ade "listings" a org-latex-packages-alist
(add-to-list 'org-latex-packages-alist '("" "listings"))
;; Establece 'listings como valor para org-latex-listings
(setq org-latex-listings 'listings)
;(setq org-latex-listings 'minted)


(require 'ox-publish)

(setq org-confirm-babel-evaluate nil
      org-export-with-broken-links t
      org-html-validation-link nil
      org-html-head-include-scripts nil
      org-html-head-include-default-style nil)

(defun my-org-latex-publish-to-pdf (plist filename pub-dir)
  "Publica un archivo Org como PDF tras ejecutar bloques de c√≥digo."
  (message "Exportando a PDF: %s" filename)
  (with-current-buffer (find-file-noselect filename)
    ;(org-babel-execute-buffer)
    ;(org-latex-export-to-pdf)
    (org-latex-publish-to-pdf plist filename pub-dir)))

(let* ((base-directory "./"))
  (setq org-publish-project-alist
        (append org-publish-project-alist
                `(("index"
                   :base-directory ,base-directory
                   :base-extension "org"
                   :publishing-directory ,(concat base-directory "docs")
                   :exclude "src\\|Calendario\\|org-lessons\\|org-practicas\\|docs\\|Lecciones-tmp\\|Practicas-tmp"
                   :recursive nil
                   :publishing-function org-html-publish-to-html
                   :auto-preamble t
                   :auto-sitemap nil
                   :with-author nil
                   :with-creator nil
                   :with-toc t
                   :section-numbers nil)

                  ("practicas-html"
                   :base-directory  "./Practicas-tmp/"
                   :base-extension "org"
                   :publishing-directory ,(concat base-directory "docs/Practicas-html")
                   :exclude "datos"
                   :recursive t
                   :publishing-function org-html-publish-to-html
                   :auto-preamble t
                   :auto-sitemap t
                   :with-author nil
                   :with-creator nil
                   :with-toc t
                   :section-numbers nil)

                  ("practicas-pdf"
                   :base-directory "./Practicas-tmp/"
                   :base-extension "org"
                   :publishing-directory ,(concat base-directory "docs/Practicas-pdf")
                   :exclude "datos\\|sitemap.org"
                   :recursive t
                   :auto-sitemap nil
                   :publishing-function my-org-latex-publish-to-pdf
                   :auto-preamble t)

                  ("practicas-static-index"
                   :base-directory "./Practicas-tmp/"
                   :base-extension "css\\|js\\|png\\|jpg\\|gif\\|dat\\|mov\\|txt\\|svg\\|aiff\\|inp"
                   :publishing-directory ,(concat base-directory "docs/Practicas-html")
                   :exclude "datos\\|hansl.tex"
                   :recursive t
                   :publishing-function org-publish-attachment)

                  ("web-repositorio" :components ("index" "practicas-html" "practicas-pdf" "practicas-static-index")))))

  (message "üü¢ Iniciando publicaci√≥n del √≠ndice (web-repositorio)...")
  (org-publish "web-repositorio" t)
  (message "‚úÖ Publicaci√≥n del √≠ndice completada."))

#+END_SRC


* slides para GitHubpages

Esta es la configuraci√≥n para convertir los Notebooks de Jupyter en slides:
#+BEGIN_SRC python :tangle mycfg-GitHubPages.py
c = get_config()

c.SlidesExporter.reveal_theme = 'solarized'
c.SlidesExporter.reveal_scroll = True
c.SlidesExporter.language_code = 'es'

c.SlidesExporter.mathjax_url = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"

c.SlidesExporter.jquery_url = "https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"

c.SlidesExporter.require_js_url = "https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"
#+END_SRC


[[https://nbconvert.readthedocs.io/en/latest/config_options.html][Configuraci√≥n para nbconvert]] (las slides usan ficheros de la web para poder funcionar en GitHubPages)

[[https://dbafromthecold.com/2021/02/21/creating-presentations-with-reveal-and-github-pages/][creating-presentations-with-reveal-and-github-pages]]

https://github.com/RichardAfolabi/Presentation_js

https://emasuriano.com/til/2024-07-01-create-presentations-from-notebook/

https://github.com/yjwen/org-reveal
https://github.com/hexmode/ox-reveal


* Directorio =.binder= para MyBinder

** Fichero =environment.yml= 

Dado que los notebooks del curso emplean algunos m√≥dulos de python, la ejecuci√≥n online en [[https://mybinder.org/][MyBinder]] de los correspondientes Notebooks de Jupyter requiere de la creaci√≥n de un fichero que indique las dependencias necesarias para que se instale el software necesario (creo que =defaults= instala el latex necesario para los gr√°ficos). 

#+BEGIN_SRC yml :tangle docs/.binder/environment.yml
name: binder-env
channels:
  - conda-forge
  - defaults
dependencies:
  - python=3.11
  - pip
  - ipykernel
  - numpy
  - pandas
  - matplotlib
  - seaborn
  - sympy
  - statsmodels
  - scipy
  - pillow  # Biblioteca necesaria para manipulaci√≥n de im√°genes (grafico arcoiris)
  - pip:
      - dataframe_image
#+END_SRC


** Fichero =apt.txt= 

Algunos gr√°ficos de los notebooks usan \LaTeX{}. Este fichero indica a MyBinder qu√© paquetes debe instalar para cubrir las dependencias.

#+BEGIN_SRC text :tangle docs/.binder/apt.txt
texlive
texlive-latex-extra
texlive-fonts-recommended
texlive-fonts-extra
dvipng
cm-super
#+END_SRC



